<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Årea do M√©dico</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* estilos r√°pidos pro modal */
    .modal          { position:fixed; top:0; left:0; width:100%; height:100%;
                      background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
    .modal-content  { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    .modal-content input{ width:100%; padding:8px; margin:6px 0; }
    .btn-consultas  { margin:6px 3px; padding:10px 15px; }
    .pasta          { background:#e9ecef; padding:8px 12px; margin:4px 0; cursor:pointer; border-radius:6px;}
  </style>
</head>
<body>
  <h1>üë®‚Äç‚öïÔ∏è Meus Pacientes</h1>

<!-- Filtro + Tabela -->
<input id="filtroPac" type="text" placeholder="üîç Pesquisar paciente..." style="width:300px;margin:8px 0;padding:6px;">
<table id="tblPacientes" border="1" style="border-collapse:collapse;width:100%;max-width:600px;">
  <thead>
    <tr>
      <th data-col="nome">Nome ‚ñ≤‚ñº</th>
      <th data-col="sobrenome">Sobrenome ‚ñ≤‚ñº</th>
      <th data-col="idade">Idade ‚ñ≤‚ñº</th>
    </tr>
  </thead>
  <tbody><tr><td colspan="3">Carregando pacientes...</td></tr></tbody>
</table>

  <button class="btn-consultas" onclick="abrirCalendario()">üìÖ Ver todas as consultas</button>
  <button class="btn-consultas" onclick="abrirModalNovoPaciente()">‚ûï Adicionar novo paciente</button>
  
  <!-- Modal Novo Paciente -->
  <div id="modalNovoPaciente" class="modal">
    <div class="modal-content">
      <h2>Novo Paciente</h2>
      <input type="text"   id="novo-nome"        placeholder="Nome"          />
      <input type="text"   id="novo-sobrenome"   placeholder="Sobrenome"     />
      <input type="email"  id="novo-email"       placeholder="E‚Äëmail"        />
      <input type="date"   id="novo-nascimento"  placeholder="Data de nasc." />
      <input type="tel"    id="novo-telefone"    placeholder="Telefone"      />
      <input type="text"   id="novo-endereco"    placeholder="Endere√ßo"      />

      <button onclick="salvarNovoPaciente()">Salvar</button>
      <button onclick="fecharModalNovoPaciente()">Cancelar</button>
    </div>
  </div>

  <script type="module">
    /* ---------- Firebase imports ---------- */
    import { initializeApp }                        from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword }
                                                   from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc,
             updateDoc, arrayUnion }               from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    /* ---------- Config ---------- */
    const firebaseConfig = {
      apiKey:            "AIzaSyAmF5FS_ekWW_7-1RUHtGCR71LH6r9fg08",
      authDomain:        "medcomvc-ubs.firebaseapp.com",
      projectId:         "medcomvc-ubs",
      storageBucket:     "medcomvc-ubs.firebasestorage.app",
      messagingSenderId: "313420248004",
      appId:             "1:313420248004:web:a9a28d97b3ef2e33c36a91"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    async function listarPacientes() {
  const tbody = document.querySelector("#tblPacientes tbody");
  tbody.innerHTML = "<tr><td colspan='3'>Carregando...</td></tr>";

  const uidMedico = localStorage.getItem("uid");
  if (!uidMedico) { tbody.innerHTML = "<tr><td colspan='3'>Erro: m√©dico n√£o identificado.</td></tr>"; return; }

  try {
    const medicoSnap = await getDoc(doc(db,"medicos",uidMedico));
    if (!medicoSnap.exists()) { tbody.innerHTML = "<tr><td colspan='3'>M√©dico n√£o encontrado.</td></tr>"; return; }

    const uids = medicoSnap.data().meuspacientes || [];
    if (!uids.length){ tbody.innerHTML = "<tr><td colspan='3'>Voc√™ ainda n√£o tem pacientes.</td></tr>"; return; }

    const dados = [];
    for (const uid of uids){
      const pSnap = await getDoc(doc(db,"pacientes",uid));
      if (!pSnap.exists()) continue;
      const id = pSnap.data().identificacao?.[0] || {};
      dados.push({ uid, nome:id.nome||"", sobrenome:id.sobrenome||"", idade:id.idade||"--" });
    }
    renderTabela(dados);
  }catch(e){ console.error(e); tbody.innerHTML = "<tr><td colspan='3'>Erro ao carregar.</td></tr>"; }
}

function renderTabela(lista){
  const tbody = document.querySelector("#tblPacientes tbody");
  if(!lista.length){ tbody.innerHTML="<tr><td colspan='3'>Nenhum paciente.</td></tr>"; return; }

  tbody.innerHTML = "";
  for(const p of lista){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${p.nome}</td><td>${p.sobrenome}</td><td style="text-align:center;">${p.idade}</td>`;
    tr.onclick = ()=>{ localStorage.setItem("pacienteSelecionado",p.uid); window.location.href="paciente_view.html"; };
    tbody.appendChild(tr);
  }
}

/* ---- Filtro de busca ---- */
document.getElementById("filtroPac").addEventListener("input", e=>{
  const termo = e.target.value.toLowerCase();
  [...document.querySelectorAll("#tblPacientes tbody tr")].forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(termo) ? "" : "none";
  });
});

/* ---- Ordena√ß√£o por cabe√ßalho ---- */
let sortDir = 1;   // 1 asc, -1 desc
document.querySelectorAll("#tblPacientes th").forEach(th=>{
  th.addEventListener("click", ()=>{
    const col = th.dataset.col;
    const rows = [...document.querySelectorAll("#tblPacientes tbody tr")];
    rows.sort((a,b)=>{
      const ta = a.children[th.cellIndex].textContent.trim().toLowerCase();
      const tb = b.children[th.cellIndex].textContent.trim().toLowerCase();
      return ta > tb ? sortDir : ta < tb ? -sortDir : 0;
    });
    sortDir *= -1;
    rows.forEach(r=> r.parentElement.appendChild(r));
  });
});

    /* ---------- Modal controls ---------- */
    function abrirCalendario() {
  localStorage.removeItem("pacienteAgenda");   // garante modo ‚Äútodas as consultas‚Äù
  window.location.href = "calendario.html";
}    function abrirModalNovoPaciente(){ document.getElementById("modalNovoPaciente").style.display="flex"; }
    function fecharModalNovoPaciente(){ document.getElementById("modalNovoPaciente").style.display="none"; }

    /* ---------- Salvar novo paciente ---------- */
    async function salvarNovoPaciente(){
      /* Coleta dados */
      const nome       = document.getElementById("novo-nome").value.trim();
      const sobrenome  = document.getElementById("novo-sobrenome").value.trim();
      const email      = document.getElementById("novo-email").value.trim();
      const nasc       = document.getElementById("novo-nascimento").value;
      const telefone   = document.getElementById("novo-telefone").value.trim();
      const endereco   = document.getElementById("novo-endereco").value.trim();

      if (!nome||!sobrenome||!email||!nasc||!telefone||!endereco){
        alert("Preencha todos os campos."); return;
      }

      const uidMedico = localStorage.getItem("uid");
      if (!uidMedico){ alert("Erro: m√©dico n√£o logado."); return; }

      try{
        /* 1. cria Auth */
        const senhaPadrao = "123456";
        const cred        = await createUserWithEmailAndPassword(auth,email,senhaPadrao);
        const uidPac      = cred.user.uid;

        /* 2. cria documento do paciente */
        const docPaciente = {
          criadoEm: new Date().toISOString(),
          calendario: [],
          documento : [],
          exame     : [],
          identificacao: [{
            nome, sobrenome,
            email,
            data_nascimento: nasc,
            telefone,
            endereco
          }],
          meusmedicos: [uidMedico],
          prontuario : [],
          resumo     : [],
          tratamento : []
        };
        await setDoc(doc(db,"pacientes",uidPac), docPaciente);

        /* 3. atualiza m√©dico */
        await updateDoc(doc(db,"medicos",uidMedico),{
          meuspacientes: arrayUnion(uidPac)
        });

        alert(`Paciente criado! UID: ${uidPac}\nSenha provis√≥ria: ${senhaPadrao}`);
        fecharModalNovoPaciente();
        listarPacientes();

      }catch(e){
        console.error(e);
        alert("Erro ao criar paciente: "+(e.message||e));
      }
    }

    /* ---------- Exposi√ß√£o no global (para onclick) ---------- */
    window.abrirCalendario            = abrirCalendario;
    window.abrirModalNovoPaciente     = abrirModalNovoPaciente;
    window.fecharModalNovoPaciente    = fecharModalNovoPaciente;
    window.salvarNovoPaciente         = salvarNovoPaciente;

    listarPacientes();
  </script>
</body>
</html>