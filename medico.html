<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Årea do M√©dico</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>üë®‚Äç‚öïÔ∏è Meus Pacientes</h1>

  <div id="lista-pacientes">
    <p>Carregando pacientes...</p>
  </div>

  <button class="btn-consultas" onclick="abrirCalendario()">üìÖ Ver todas as consultas</button>
  <button class="btn-consultas" onclick="abrirModalNovoPaciente()">‚ûï Adicionar novo paciente</button>
  <button onclick="sair()">üö™ Sair</button>

  <div id="modalNovoPaciente" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Novo Paciente</h2>
      <input type="text" id="novo-nome" placeholder="Nome" />
      <input type="text" id="novo-sobrenome" placeholder="Sobrenome" />
      <input type="number" id="novo-idade" placeholder="Idade" />
      <input type="text" id="novo-cidade" placeholder="Cidade" />
      <input type="text" id="novo-estado" placeholder="Estado" />
      <button onclick="salvarNovoPaciente()">Salvar</button>
      <button onclick="fecharModalNovoPaciente()">Cancelar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmF5FS_ekWW_7-1RUHtGCR71LH6r9fg08",
      authDomain: "medcomvc-ubs.firebaseapp.com",
      projectId: "medcomvc-ubs",
      storageBucket: "medcomvc-ubs.appspot.com",
      messagingSenderId: "313420248004",
      appId: "1:313420248004:web:a9a28d97b3ef2e33c36a91",
      measurementId: "G-04YK0WXT42"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function abrirCalendario() {
      alert("üîî Ver todas as consultas");
    }

    function abrirModalNovoPaciente() {
      document.getElementById("modalNovoPaciente").style.display = "flex";
    }

    function fecharModalNovoPaciente() {
      document.getElementById("modalNovoPaciente").style.display = "none";
    }

    function sair() {
      localStorage.removeItem("uid");
      window.location.href = "index.html";
    }

    async function listarPacientes(uidMedico) {
      const container = document.getElementById('lista-pacientes');
      container.innerHTML = "<p>Carregando pacientes...</p>";

      console.log("üîë UID do m√©dico:", uidMedico);

      if (!uidMedico) {
        container.innerHTML = "<p>Erro: m√©dico n√£o identificado.</p>";
        return;
      }

      try {
        const refMedico = doc(db, "medicos", uidMedico);
        const snapMedico = await getDoc(refMedico);

        if (!snapMedico.exists()) {
          container.innerHTML = "<p>M√©dico n√£o encontrado no banco de dados.</p>";
          return;
        }

        const dadosMedico = snapMedico.data();
        const listaPacientes = dadosMedico.meuspacientes || [];

        if (listaPacientes.length === 0) {
          container.innerHTML = "<p>Voc√™ ainda n√£o tem pacientes cadastrados.</p>";
          return;
        }

        container.innerHTML = "";

        for (const uidPaciente of listaPacientes) {
          const refPaciente = doc(db, "pacientes", uidPaciente);
          const snapPaciente = await getDoc(refPaciente);

          if (snapPaciente.exists()) {
            const dados = snapPaciente.data();
            const identificacao = dados.identificacao?.[0] || {};
            const nome = identificacao.nome || "Paciente";
            const sobrenome = identificacao.sobrenome || "";

            const div = document.createElement("div");
            div.className = "pasta";
            div.textContent = `${nome} ${sobrenome}`;
            div.onclick = () => {
              localStorage.setItem("pacienteSelecionado", uidPaciente);
              window.location.href = "paciente_view.html";
            };
            container.appendChild(div);
          } else {
            const aviso = document.createElement("div");
            aviso.className = "pasta";
            aviso.textContent = `‚ö†Ô∏è Paciente n√£o encontrado: ${uidPaciente}`;
            aviso.style.color = "red";
            container.appendChild(aviso);
          }
        }
      } catch (e) {
        console.error("‚ùå Erro ao buscar pacientes:", e);
        document.getElementById("lista-pacientes").innerHTML = "<p>Erro ao carregar pacientes. Verifique o console.</p>";
      }
    }

    // Verifica se o usu√°rio est√° autenticado
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("‚úÖ Usu√°rio autenticado:", user.uid);
        localStorage.setItem("uid", user.uid);
        listarPacientes(user.uid);
      } else {
        console.warn("‚ùå Usu√°rio N√ÉO autenticado.");
        document.getElementById("lista-pacientes").innerHTML = "<p>Voc√™ n√£o est√° autenticado. Por favor, volte √† tela de login.</p>";
      }
    });

    // Tornar fun√ß√µes vis√≠veis globalmente
    window.abrirModalNovoPaciente = abrirModalNovoPaciente;
    window.fecharModalNovoPaciente = fecharModalNovoPaciente;
    window.abrirCalendario = abrirCalendario;
    window.sair = sair;
  </script>
</body>
</html>