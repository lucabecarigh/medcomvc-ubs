<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Årea do M√©dico</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>üë®‚Äç‚öïÔ∏è Meus Pacientes</h1>

  <div id="lista-pacientes">
    <p>Carregando pacientes...</p>
  </div>

  <button class="btn-consultas" onclick="abrirCalendario()">üìÖ Ver todas as consultas</button>
  <button class="btn-consultas" onclick="abrirModalNovoPaciente()">‚ûï Adicionar novo paciente</button>
  
  <div id="modalNovoPaciente" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Novo Paciente</h2>
      <input type="text" id="novo-nome" placeholder="Nome" />
      <input type="text" id="novo-sobrenome" placeholder="Sobrenome" />
      <input type="number" id="novo-idade" placeholder="Idade" />
      <input type="text" id="novo-cidade" placeholder="Cidade" />
      <input type="text" id="novo-estado" placeholder="Estado" />
      <button onclick="salvarNovoPaciente()">Salvar</button>
      <button onclick="fecharModalNovoPaciente()">Cancelar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmF5FS_ekWW_7-1RUHtGCR71LH6r9fg08",
      authDomain: "medcomvc-ubs.firebaseapp.com",
      projectId: "medcomvc-ubs",
      storageBucket: "medcomvc-ubs.appspot.com",
      messagingSenderId: "313420248004",
      appId: "1:313420248004:web:a9a28d97b3ef2e33c36a91"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function listarPacientes() {
      const container = document.getElementById('lista-pacientes');
      container.innerHTML = "<p>Carregando pacientes...</p>";

      const uidMedico = localStorage.getItem("uid");
      if (!uidMedico) {
        container.innerHTML = "<p>Erro: m√©dico n√£o identificado.</p>";
        return;
      }

      try {
        const medicoRef = doc(db, "medicos", uidMedico);
        const medicoSnap = await getDoc(medicoRef);

        if (!medicoSnap.exists()) {
          container.innerHTML = "<p>M√©dico n√£o encontrado no Firestore.</p>";
          return;
        }

        const dadosMedico = medicoSnap.data();
        const meuspacientes = dadosMedico.meuspacientes || [];

        if (meuspacientes.length === 0) {
          container.innerHTML = "<p>Voc√™ ainda n√£o tem pacientes vinculados.</p>";
          return;
        }

        container.innerHTML = "";

        for (const uidPaciente of meuspacientes) {
          const pacienteRef = doc(db, "pacientes", uidPaciente);
          const pacienteSnap = await getDoc(pacienteRef);

          if (pacienteSnap.exists()) {
            const dadosPaciente = pacienteSnap.data();
            const identificacao = dadosPaciente.identificacao?.[0] || {};
            const nome = identificacao.nome || "Paciente";
            const sobrenome = identificacao.sobrenome || "";
            const idade = identificacao.idade || "";

            const div = document.createElement("div");
            div.classList.add("pasta");
            div.innerText = `${nome} ${sobrenome} (${idade} anos)`;
            div.onclick = () => {
              localStorage.setItem("pacienteSelecionado", uidPaciente);
              window.location.href = "paciente_view.html";
            };
            container.appendChild(div);
          }
        }
      } catch (error) {
        console.error("Erro ao carregar pacientes:", error);
        container.innerHTML = "<p>Erro ao carregar pacientes.</p>";
      }
    }

    function abrirCalendario() {
      alert("Exibir calend√°rio com todas as consultas.");
    }

    function abrirModalNovoPaciente() {
      document.getElementById("modalNovoPaciente").style.display = "flex";
    }

    function fecharModalNovoPaciente() {
      document.getElementById("modalNovoPaciente").style.display = "none";
    }

    window.abrirCalendario = abrirCalendario;
    window.abrirModalNovoPaciente = abrirModalNovoPaciente;
    window.fecharModalNovoPaciente = fecharModalNovoPaciente;

    listarPacientes();
  </script>
</body>
</html>